<div class="page productos-page">
  <h1><span class="page-icon">ðŸ“¦</span> Gestionar Productos</h1>
  <div class="actions">
    <a routerLink="/productos/nuevo" class="btn-primary">+ AÃ±adir producto</a>
  </div>

  <div class="table-filter">
    <input type="text" [(ngModel)]="filterText" (input)="onFilterTextChange()" placeholder="Buscar por cÃ³digo, descripciÃ³n, subcategorÃ­a..." />
    <select [(ngModel)]="filterSubcategoriaId" (ngModelChange)="onFilterChange($event, undefined)">
      <option value="">Todas las subcategorÃ­as</option>
      @for (s of subcategorias; track s.subcategoria_id) {
        <option [value]="s.subcategoria_id">{{ s.nombre }}</option>
      }
    </select>
    <select [(ngModel)]="filterAlmacenId" (ngModelChange)="onFilterChange(undefined, $event)">
      <option value="">Todos los almacenes</option>
      @for (a of almacenes; track a.almacen_id) {
        <option [value]="a.almacen_id">{{ a.nombre }}</option>
      }
    </select>
  </div>
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>CÃ³digo</th>
          <th>DescripciÃ³n</th>
          <th>SubcategorÃ­a</th>
          <th>Precio</th>
          <th>{{ existenciaColumnLabel }}</th>
          <th>Estatus</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        @if (productosFiltrados.length === 0 && !loading) {
          <tr><td colspan="8" class="empty">No hay productos</td></tr>
        }
        @for (p of productosPaginados; track p.producto_id) {
          <tr>
            <td>{{ p.producto_id }}</td>
            <td>{{ p.codigo_interno }}</td>
            <td>{{ p.descripcion || p.nombre }}</td>
            <td>{{ p.subcategoria_nombre || '-' }}</td>
            <td>{{ p.precio_venta_sugerido }}</td>
            <td>{{ p.existencia_actual }}</td>
            <td><span class="badge" [class.activo]="(p.estatus || 'A') === 'A'" [class.cancelado]="(p.estatus || 'A') === 'C'">{{ (p.estatus || 'A') === 'A' ? 'Activo' : 'Cancelado' }}</span></td>
            <td class="actions-cell">
              <div class="actions-cell-inner">
              <button type="button" class="btn-icon" (click)="$event.stopPropagation(); $event.preventDefault(); openStockModal(p.producto_id)" title="Actualizar stock">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                <span>Stock</span>
              </button>
              <a [routerLink]="['/productos', p.producto_id, 'editar']" class="btn-icon" title="Editar">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
                <span>Editar</span>
              </a>
              <button class="btn-toggle" (click)="toggleEstatus(p)" [title]="(p.estatus || 'A') === 'A' ? 'Deshabilitar' : 'Habilitar'">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
                {{ (p.estatus || 'A') === 'A' ? 'Deshabilitar' : 'Habilitar' }}
              </button>
              @if (!p.tiene_ventas) {
                <button class="btn-danger" (click)="eliminar(p)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                  Eliminar
                </button>
              }
              </div>
            </td>
          </tr>
        }
      </tbody>
    </table>
    @if (productosFiltrados.length > pageSize) {
      <div class="pagination-wrapper">
        <div class="pagination">
          <button (click)="currentPage = 1" [disabled]="currentPage === 1">Â«</button>
          <button (click)="currentPage = currentPage - 1" [disabled]="currentPage === 1">â€¹</button>
          <span>PÃ¡gina {{ currentPage }} de {{ totalPages }}</span>
          <button (click)="currentPage = currentPage + 1" [disabled]="currentPage === totalPages">â€º</button>
          <button (click)="currentPage = totalPages" [disabled]="currentPage === totalPages">Â»</button>
        </div>
      </div>
    }
  </div>

  @if (stockModalProducto) {
    <div class="modal-overlay" (click)="closeStockModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Actualizar stock â€” {{ stockModalProducto.descripcion || stockModalProducto.nombre || stockModalProducto.codigo_interno }}</h3>
          <button type="button" class="modal-close" (click)="closeStockModal()">Ã—</button>
        </div>
        <form class="modal-body" (ngSubmit)="saveStock()">
          <p class="hint" style="margin-bottom: 1rem;">Indica la cantidad a <strong>sumar</strong> a cada almacÃ©n. Se aÃ±adirÃ¡ al stock actual.</p>
          <div class="stock-modal-almacenes">
            @for (item of stockModalInputs; track item.almacen_id) {
              <div class="stock-modal-row">
                <span class="stock-modal-almacen">{{ item.almacen_nombre }}</span>
                <span class="stock-modal-actual">Actual: {{ item.stock_actual }}</span>
                <input type="number" [(ngModel)]="item.cantidad_a_sumar" name="stock_{{ item.almacen_id }}" min="0" step="1" inputmode="numeric" placeholder="Cantidad a sumar" class="stock-modal-input" (keypress)="onlyNumbers($event)" (paste)="onStockPaste($event, item)" />
              </div>
            }
          </div>
          <div class="form-row" style="margin-top: 1rem;">
            <label>Precio venta sugerido (opcional)</label>
            <input type="number" [(ngModel)]="stockModalPrecio" name="precio" min="0" step="0.01" placeholder="Precio" />
          </div>
          <div class="form-actions" style="margin-top: 1.5rem;">
            <button type="button" class="btn-secondary" (click)="closeStockModal()">Cancelar</button>
            <button type="submit" class="btn-primary" [disabled]="stockModalSaving">
              {{ stockModalSaving ? 'Guardando...' : 'Guardar' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
